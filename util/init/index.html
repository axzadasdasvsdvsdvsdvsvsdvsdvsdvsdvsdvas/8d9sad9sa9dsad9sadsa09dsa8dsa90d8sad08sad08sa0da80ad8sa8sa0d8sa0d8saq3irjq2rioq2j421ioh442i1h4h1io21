<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Big Walk</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- bg overlay layers (wallpaper fica no CSS via body::before) -->
  <div class="bg" aria-hidden="true">
    <div class="vignette"></div>
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="grain"></div>
  </div>

  <header class="titlebar" role="banner">
    <div class="titlebar-left">
      <div class="appmark" aria-hidden="true">
        <img class="app-ico" src="./assets/favicon.png" alt="" />
      </div>

      <div class="titlewrap">
        <div class="title">Big Walk Installer</div>
        <div class="subtitle">House House | beta</div>
      </div>
    </div>

    <div class="titlebar-right" role="group" aria-label="Window controls">
      <button class="winbtn" type="button" aria-label="Minimize" data-win="minimize" title="Minimize">
        <span aria-hidden="true">—</span>
      </button>
      <button class="winbtn" type="button" aria-label="Maximize" data-win="maximize" title="Maximize">
        <span aria-hidden="true">▢</span>
      </button>
      <button class="winbtn danger" type="button" aria-label="Close" data-win="close" title="Close">
        <span aria-hidden="true">✕</span>
      </button>
    </div>
  </header>

  <main class="shell">
    <aside class="rail" aria-label="Installer steps">
      <div class="rail-top">
        <section class="product">
          <div class="product-head">
            <div class="product-name">Big Walk</div>
            <div class="pill">Beta</div>
          </div>
          <div class="product-meta">
            <div class="meta-row">
              <span class="k">Version</span>
              <span class="v" id="versionText">1.3.1-beta</span>
            </div>
            <div class="meta-row">
              <span class="k">Publisher</span>
              <span class="v">House House</span>
            </div>
          </div>
        </section>

        <!-- ✅ AGORA OS BOTOES VAO SER CRIADOS VIA JS -->
        <nav class="steps" id="stepsNav" aria-label="Steps"></nav>

        <section class="rail-card">
          <div class="rail-card-title">System</div>
          <div class="rail-card-grid">
            <div class="kv">
              <span class="k">Target</span>
              <span class="v">x64</span>
            </div>
            <div class="kv">
              <span class="k">Required space</span>
              <span class="v" id="diskReq">~6.2 GB</span>
            </div>
          </div>
        </section>
      </div>

      <div class="rail-bottom">
        <div class="fineprint" id="legalFine">
          © <span id="year">2026</span> House House. All rights reserved.
        </div>
      </div>
    </aside>

    <section class="panel" aria-label="Installer content">
      <div class="panel-inner">
        <section class="view show" id="view-welcome" data-view="welcome">
          <div class="hero">
            <div class="hero-copy">
              <div class="eyebrow">Ready to install</div>
              <h1>Install Big Walk</h1>
              <p class="lead">
                This is a beta build. Choose install folder, optional shortcuts, and launch right after install.
              </p>

              <div class="cards">
                <div class="card">
                  <div class="card-ico ok">✔</div>
                  <div class="card-body">
                    <div class="card-title">Disk space</div>
                    <div class="card-sub"><span class="mono" id="diskReq2">~6.2 GB</span> required</div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-ico ok">✔</div>
                  <div class="card-body">
                    <div class="card-title">Permissions</div>
                    <div class="card-sub">Standard user supported</div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-ico ok">✔</div>
                  <div class="card-body">
                    <div class="card-title">Integrity</div>
                    <div class="card-sub">Installer package verified</div>
                  </div>
                </div>
              </div>

              <div class="notice">
                <div class="notice-dot"></div>
                <div class="notice-text">
                  Tip: keep default folder and hit <b>Install</b>.
                </div>
              </div>
            </div>

            <div class="hero-art" aria-hidden="true">
              <div class="hero-art-badge">
                <div class="badge-title">Big Walk</div>
                <div class="badge-sub">Beta installer</div>
              </div>
              <div class="hero-grid"></div>
              <div class="hero-orb"></div>
            </div>
          </div>
        </section>

        <section class="view" id="view-path" data-view="path">
          <h2>Install location</h2>
          <p class="muted">Choose where Big Walk will be installed.</p>

          <div class="field">
            <label class="field-label" for="installPath">Install folder</label>
            <div class="field-row">
              <input class="input mono" id="installPath" type="text" spellcheck="false"
                value="C:\Program Files\Big Walk" />
              <button class="btn" type="button" id="btnBrowse">Browse</button>
            </div>
            <div class="field-help muted">Recommended: SSD. Avoid removable drives.</div>
          </div>

          <div class="split">
            <div class="panel-card">
              <div class="panel-card-title">Shortcuts</div>

              <label class="checkrow">
                <input type="checkbox" id="optDesktop" checked />
                <span class="checkui"></span>
                <span class="checktext">Create Desktop shortcut</span>
              </label>

              <label class="checkrow">
                <input type="checkbox" id="optStart" checked />
                <span class="checkui"></span>
                <span class="checktext">Add to Start Menu</span>
              </label>

              <label class="checkrow">
                <input type="checkbox" id="optAutoUpdate" />
                <span class="checkui"></span>
                <span class="checktext">Enable auto-updates (recommended)</span>
              </label>
            </div>

            <div class="panel-card">
              <div class="panel-card-title">Summary</div>
              <div class="kv"><span class="k">Size</span><span class="v">6.2 GB</span></div>
              <div class="kv"><span class="k">Architecture</span><span class="v">x64</span></div>
              <div class="kv"><span class="k">Install for</span><span class="v">Current user</span></div>
              <div class="divider"></div>
              <div class="muted small">You can change these later.</div>
            </div>
          </div>
        </section>

        <section class="view" id="view-install" data-view="install">
          <h2>Installing</h2>
          <p class="muted" id="installStatus">Preparing…</p>

          <div class="progress-card">
            <div class="progress-top">
              <div class="progress-label">Progress</div>
              <div class="progress-pct" id="progressPct">0%</div>
            </div>
            <div class="progressbar">
              <div class="progressfill" id="progressFill"></div>
            </div>
            <div class="progress-meta">
              <span class="muted small" id="progressMeta">Waiting to start</span>
              <span class="mono small" id="progressSpeed">—</span>
            </div>
          </div>

          <div class="logwrap">
            <div class="loghead">
              <div class="logtitle">Details</div>
              <div class="logactions">
                <button class="btn ghost" type="button" id="btnCopyLog">Copy</button>
                <button class="btn ghost" type="button" id="btnClearLog">Clear</button>
              </div>
            </div>
            <pre class="log mono" id="logBox"></pre>
          </div>

          <div class="muted small" style="margin-top:14px;">Do not close the installer during installation.</div>
        </section>

        <section class="view" id="view-finish" data-view="finish">
          <div class="finish">
            <div class="finish-badge">✔</div>
            <h2>Installation complete</h2>
            <p class="muted">Big Walk was successfully installed.</p>

            <div class="panel-card" style="margin-top:12px;">
              <div class="panel-card-title">Next</div>

              <label class="checkrow">
                <input type="checkbox" id="optLaunch" checked />
                <span class="checkui"></span>
                <span class="checktext">Launch Big Walk</span>
              </label>

              <label class="checkrow">
                <input type="checkbox" id="optOpenFolder" />
                <span class="checkui"></span>
                <span class="checktext">Open install folder</span>
              </label>

              <div class="divider"></div>

              <div class="kv">
                <span class="k">Installed to</span>
                <span class="v mono" id="finalPath">C:\Program Files\Big Walk</span>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="bbar" aria-label="Installer actions">
        <div class="bbar-left">
          <button class="btn ghost" type="button" id="btnCancel">Cancel</button>
        </div>

        <div class="bbar-right">
          <button class="btn" type="button" id="btnBack">Back</button>
          <button class="btn primary" type="button" id="btnNext">Next</button>
        </div>
      </footer>

      <div class="toast" id="toast" role="status" aria-live="polite">
        <div class="toast-dot"></div>
        <div class="toast-text" id="toastText">—</div>
      </div>
    </section>
  </main>

  <script>
    let ipc = null;
    try { ipc = require('electron').ipcRenderer; } catch (_) {}

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const stepsDef = [
      { key: 'welcome', label: 'Welcome',  hint: 'Quick checks' },
      { key: 'path',    label: 'Location', hint: 'Choose folder' },
      { key: 'install', label: 'Install',  hint: 'Copying files' },
      { key: 'finish',  label: 'Finish',   hint: 'Launch options' },
    ];

    const state = {
      step: 'welcome',
      steps: stepsDef.map(s => s.key),
      unlocked: 0,       // ✅ até qual index já “nasceu” no rail
      installing: false,
      installed: false,
      progress: 0,
      timer: null,
    };

    function toast(msg) {
      const el = $('#toast');
      $('#toastText').textContent = msg;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(() => el.classList.remove('show'), 2200);
    }

    // ✅ cria os botões conforme desbloqueia
    function ensureRailUpTo(index) {
      const nav = $('#stepsNav');
      if (!nav) return;

      const target = Math.max(0, Math.min(stepsDef.length - 1, index));

      // cria só os que faltam
      while (nav.children.length <= target) {
        const i = nav.children.length;
        const s = stepsDef[i];

        const btn = document.createElement('button');
        btn.className = 'step';
        btn.type = 'button';
        btn.dataset.step = s.key;

        btn.innerHTML = `
          <span class="dot"></span>
          <span class="label">${s.label}</span>
          <span class="hint">${s.hint}</span>
        `;

        // clicável só se já “nasceu” e não tá instalando
        btn.addEventListener('click', () => {
          if (state.installing) return;
          const idx = state.steps.indexOf(s.key);
          if (idx <= state.unlocked) setStep(s.key);
        });

        nav.appendChild(btn);
      }

      state.unlocked = Math.max(state.unlocked, target);
    }

    function setStep(step) {
      if (!state.steps.includes(step)) return;
      if (state.installing && step !== 'install') return;
      if (!state.installed && step === 'finish') return;

      const idx = state.steps.indexOf(step);
      ensureRailUpTo(idx);

      state.step = step;

      // views
      $$('.view').forEach(v => v.classList.remove('show'));
      const view = $('#view-' + step);
      if (view) view.classList.add('show');

      // rail active
      $$('#stepsNav .step').forEach(btn => {
        const isActive = btn.dataset.step === step;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-current', isActive ? 'step' : 'false');
      });

      // footer buttons
      $('#btnBack').disabled = (idx === 0) || state.installing;
      $('#btnCancel').disabled = false;
      $('#btnNext').textContent = step === 'finish' ? 'Close' : (step === 'install' ? 'Installing…' : 'Next');
      $('#btnNext').disabled = state.installing && step === 'install';

      const p = $('#installPath')?.value || '—';
      const fp = $('#finalPath');
      if (fp) fp.textContent = p;
    }

    function log(line) {
      const box = $('#logBox');
      box.textContent += line + '\n';
      box.scrollTop = box.scrollHeight;
    }

    function setProgress(pct, meta, speed) {
      state.progress = Math.max(0, Math.min(100, pct));
      $('#progressPct').textContent = state.progress.toFixed(0) + '%';
      $('#progressFill').style.width = state.progress + '%';
      $('#progressMeta').textContent = meta || '';
      $('#progressSpeed').textContent = speed || '—';
    }

    // ====== config de tamanho/tempo (simulação realista) ======
const REQUIRED_GB = 6.2;
const REQUIRED_BYTES = REQUIRED_GB * 1024 * 1024 * 1024;

// 5–8 minutos
const INSTALL_MIN_MS = 5 * 60 * 1000;
const INSTALL_MAX_MS = 8 * 60 * 1000;

function fmtGB(bytes) {
  return (bytes / (1024 * 1024 * 1024)).toFixed(2) + " GB";
}
function fmtMBps(mbps) {
  return mbps.toFixed(1) + " MB/s";
}
function easeOutCubic(t) {
  return 1 - Math.pow(1 - t, 3);
}

// garante q o texto do tamanho fica certo (mesmo se esquecer no html)
function applySizeLabels() {
  const a = document.querySelector('#diskReq');
  const b = document.querySelector('#diskReq2');
  if (a) a.textContent = `~${REQUIRED_GB.toFixed(1)} GB`;
  if (b) b.textContent = `~${REQUIRED_GB.toFixed(1)} GB`;
  // tenta atualizar o summary "Size" sem precisar id (pega o primeiro "Size" do summary)
  document.querySelectorAll('.panel-card .kv').forEach(kv => {
    const k = kv.querySelector('.k');
    const v = kv.querySelector('.v');
    if (k && v && k.textContent.trim().toLowerCase() === 'size') {
      v.textContent = `${REQUIRED_GB.toFixed(1)} GB`;
    }
  });
}

// chama isso no DOMContentLoaded (bota junto do que vc já tem)
document.addEventListener('DOMContentLoaded', () => {
  applySizeLabels();
});

// ====== SUBSTITUI A FUNÇÃO startInstall() POR ESSA ======
function startInstall() {
  if (state.installing) return;

  state.installing = true;
  state.installed = false;

  // duração aleatória 5–8 min
  const durationMs = INSTALL_MIN_MS + Math.random() * (INSTALL_MAX_MS - INSTALL_MIN_MS);
  const startMs = performance.now();

  // taxa média pra bater a duração (MB/s)
  const durationSec = durationMs / 1000;
  const avgRateMBps = (REQUIRED_BYTES / (1024 * 1024)) / durationSec;

  // smooth de velocidade
  let shownMBps = avgRateMBps;
  let lastT = 0;

  $('#installStatus').textContent = 'Installing Big Walk…';
  $('#logBox').textContent = '';
  setProgress(0, 'Starting', '—');

  toast('Installation started');
  log('[setup] starting installer');
  log('[setup] target: ' + ($('#installPath').value || 'unknown'));
  log(`[setup] package size: ${REQUIRED_GB.toFixed(1)} GB`);
  log(`[setup] estimated time: ${Math.round(durationSec / 60)} min`);

  let phase = 0;
  let lastLogAt = 0;

  // tick mais “humano”, sem ficar aceleradão
  state.timer = setInterval(() => {
    const now = performance.now();
    const rawT = Math.min(1, (now - startMs) / durationMs);
    const t = easeOutCubic(rawT); // sobe mais “bonito”
    const pct = t * 100;

    // bytes “baixados/instalados” na simulação
    const doneBytes = REQUIRED_BYTES * t;

    // define fases por % (só pra log/meta parecer real)
    if (phase === 0 && pct > 3)  { phase = 1; log('[setup] initializing download…'); }
    if (phase === 1 && pct > 12) { phase = 2; log('[setup] downloading package…'); }
    if (phase === 2 && pct > 72) { phase = 3; log('[setup] verifying + extracting…'); }
    if (phase === 3 && pct > 90) { phase = 4; log('[setup] installing files…'); }
    if (phase === 4 && pct > 97) { phase = 5; log('[setup] finalizing…'); }

    // velocidade: fica perto da média, com variação leve
    // (e ainda respeita a duração pq a % vem do tempo)
    const wobble = 0.80 + Math.random() * 0.45; // 0.80–1.25
    const targetMBps = avgRateMBps * wobble;

    // suaviza pra não ficar pulando demais
    shownMBps = shownMBps * 0.82 + targetMBps * 0.18;

    // meta bonitinha com progresso em GB
    const meta =
      pct < 12 ? `Preparing (${fmtGB(doneBytes)} / ${REQUIRED_GB.toFixed(1)} GB)` :
      pct < 72 ? `Downloading (${fmtGB(doneBytes)} / ${REQUIRED_GB.toFixed(1)} GB)` :
      pct < 90 ? `Extracting (${fmtGB(doneBytes)} / ${REQUIRED_GB.toFixed(1)} GB)` :
      pct < 97 ? `Installing (${fmtGB(doneBytes)} / ${REQUIRED_GB.toFixed(1)} GB)` :
      `Finalizing (${fmtGB(doneBytes)} / ${REQUIRED_GB.toFixed(1)} GB)`;

    setProgress(pct, meta, fmtMBps(shownMBps));

    // solta logs “de vez em quando”
    if ((now - lastLogAt) > (2200 + Math.random() * 1800) && pct < 99.5) {
      lastLogAt = now;
      const items = [
        `received chunk (${fmtGB(doneBytes)} / ${REQUIRED_GB.toFixed(1)} GB)`,
        'checking checksum…',
        'writing to disk…',
        'optimizing assets…',
        'updating registry entries…',
      ];
      log('[setup] ' + items[(Math.random() * items.length) | 0]);
    }

    lastT = t;

    if (rawT >= 1) {
      clearInterval(state.timer);
      state.timer = null;

      state.installing = false;
      state.installed = true;

      setProgress(100, `Done (${REQUIRED_GB.toFixed(1)} GB)`, fmtMBps(avgRateMBps));
      log('[setup] done');
      $('#installStatus').textContent = 'Done.';
      toast('Installed successfully');

      ensureRailUpTo(state.steps.indexOf('finish'));
      setStep('finish');
      $('#btnNext').textContent = 'Close';
    }
  }, 350);
}

    function nextStep() {
      if (state.step === 'finish') {
        if (ipc) ipc.send('ui:win', 'close');
        else window.close();
        return;
      }

      if (state.step === 'path') {
        const p = $('#installPath').value.trim();
        if (!p) return toast('Pick a valid install folder.');
      }

      if (state.step === 'install') return;

      const idx = state.steps.indexOf(state.step);
      const next = state.steps[idx + 1];
      if (!next) return;

      // ✅ faz o próximo “nascer” no rail antes de entrar nele
      ensureRailUpTo(idx + 1);

      if (next === 'install') {
        setStep('install');
        startInstall();
        return;
      }

      setStep(next);
    }

    function backStep() {
      if (state.installing) return;
      const idx = state.steps.indexOf(state.step);
      const prev = state.steps[idx - 1];
      if (prev) setStep(prev);
    }

    function cancelAndHide() {
      const ok = confirm('Do you really want to cancel?');
      if (!ok) return;

      if (state.timer) {
        clearInterval(state.timer);
        state.timer = null;
      }
      state.installing = false;

      if (ipc) ipc.send('ui:app', 'hideAll');
      else window.close();
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#year').textContent = new Date().getFullYear();

      // ✅ começa com só Welcome no rail
      ensureRailUpTo(0);
      setStep('welcome');

      $('#btnNext').addEventListener('click', nextStep);
      $('#btnBack').addEventListener('click', backStep);
      $('#btnCancel').addEventListener('click', cancelAndHide);

      // Browse real via IPC
      $('#btnBrowse').addEventListener('click', async () => {
        if (!ipc) return toast('Browse unavailable (no IPC).');

        const cur = $('#installPath')?.value || '';
        let picked = null;

        try {
          picked = await ipc.invoke('ui:browseFolder', cur);
        } catch (e) {
          console.error(e);
          toast('Browse failed (IPC error).');
          return;
        }

        if (!picked) return;
        $('#installPath').value = picked;
        toast('Folder selected');
      });

      $('#btnCopyLog').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText($('#logBox').textContent); toast('Copied'); }
        catch { toast('Copy failed'); }
      });
      $('#btnClearLog').addEventListener('click', () => { $('#logBox').textContent=''; toast('Cleared'); });

      // win buttons
      $$('.winbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const a = btn.dataset.win;
          if (!ipc) return;
          ipc.send('ui:win', a);
        });
      });
    });
  </script>
</body>
</html>
